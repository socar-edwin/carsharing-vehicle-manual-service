# ===========================================
# carsharing-vehicle-manual-service - Development CI/CD
# 개발 환경 배포 파이프라인
# ===========================================

name: cicd-dev

on:
  push:
    branches:
      - develop

env:
  ACTION_REPO: "socar-inc/socar-actions"
  ACTION_REF: "v2.0"
  IMG_REPO: "carsharing-vehicle-manual-service"

jobs:
  ci:
    runs-on: ubuntu-20.04
    outputs:
      image-tag: ${{ steps.set-tag.outputs.image-tag }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "image-tag=dev-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Checkout custom action repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ACTION_REPO }}
          ref: ${{ env.ACTION_REF }}
          token: ${{ secrets.GH_TOKEN }}
          path: ./.github/actions

      - name: Run actions/ci - ${{ env.IMG_REPO }}
        uses: ./.github/actions/ci
        with:
          img-registry: ${{ secrets.DEV_ECR_REGISTRY }}
          img-repo: ${{ env.IMG_REPO }}
          img-tag: ${{ steps.set-tag.outputs.image-tag }}
          aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

  cd:
    runs-on: ubuntu-20.04
    needs: [ci]
    steps:
      - name: Checkout custom action repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ACTION_REPO }}
          ref: ${{ env.ACTION_REF }}
          token: ${{ secrets.GH_TOKEN }}
          path: ./.github/actions

      - name: Run actions/cd - ${{ env.IMG_REPO }}
        uses: ./.github/actions/cd
        with:
          img-repo: ${{ env.IMG_REPO }}
          img-tag: ${{ needs.ci.outputs.image-tag }}
          helm-repo: ${{ secrets.DEV_HELM_CHART_REPO }}
          helm-path: ${{ env.IMG_REPO }}
          helm-branch: main
          helm-values-file: values-dev.yaml
          argocd-server: ${{ secrets.DEV_ARGOCD_SERVER }}
          argocd-app: ${{ env.IMG_REPO }}-dev
          argocd-token: ${{ secrets.DEV_ARGOCD_TOKEN }}
          github-token: ${{ secrets.GH_TOKEN }}
